
import sys
import os
from seleniumrunner.pytest_utils.ReadCaseData import ReadCasePlugin
import pytest


def main():
    # 获取 python运行参数
    # 1. 读取命令行传入的参数
    pytest_cmd_config = []
    report_path = ""
    for index in range(1, len(sys.argv)):
        if str(sys.argv[index]).__contains__('--report-path'):
            print('sys.argv[{}]:{}'.format(index, sys.argv[index]))
            if str(sys.argv[index]).__contains__('='):
                report_path = str(sys.argv[index]).split('=')[1]
            else:  # 如果以空格分隔的话，则取其后面一个数据
                report_path = str(sys.argv[index+1])
        else:
            if not(sys.argv[index].__eq__(report_path)):
                pytest_cmd_config.append(sys.argv[index])
    print('report_path=', report_path)

    # 2. 构建pytest参数
    sys_path = os.path.join(os.path.dirname(__file__))
    pytest_args = ["-s", "-v", "--capture=sys"
                    , "--driver=FIREFOX"
                    , "--host=192.168.86.131"
                    , "--port=4444"
                    , "--capability=FIREFOX"
                    , '--alluredir'
                    , './test_result'
                    , '--clean-alluredir'
                    , sys_path + "/TestCaseClass.py"]
    pytest_args.extend(pytest_cmd_config)
    print("run pytest：", pytest_args)
    pytest.main(pytest_args, plugins=[ReadCasePlugin()])
    # report_path文件夹不存在时，会自动创建
    report_dir = './'+report_path+'/html/'
    os.system("allure generate ./test_result/ -o " + report_dir + "  --clean")
